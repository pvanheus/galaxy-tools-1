<tool id="ariba_sum" name="ARIBA summary" version="@VERSION@">
    <description>
        Summarises the results from one or more runs of ARIBA
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="version_command" />

    <command detect_errors="exit_code"><![CDATA[
        
        #import re
        ## Creates symlinks for each input file based on the Galaxy 'element_identifier'
        ## Used so that a human-readable name appears in the output table (instead of 'dataset_xyz.dat')
        #set $named_input_files = ''
        #for $input_file in $ariba_reports
            ## Add single quotes around each input file identifier
            #set $_input_file = "'{}'".format($input_file.element_identifier)
            ln -s '${input_file}' ${_input_file} &&
            #set $named_input_files = $named_input_files + ' ' + $_input_file
        #end for
        ariba summary out 
        
        --preset $options.preset
        --cluster_cols $options.cluster_cols
        
        #if $options.col_filter
            $options.col_filter
        #end if

        #if $options.no_tree
            $options.no_tree
        #end if

        #if $options.row_filter
            $options.row_filter
        #end if

        --min_id $options.min_id

        #if $options.v_groups
            $options.v_groups
        #end if

        #if $options.known_variants
            $options.known_variants
        #end if

        #if $options.novel_variants
            $options.novel_variants
        #end if

        $named_input_files
        > $log
    ]]>    </command>
    <inputs>
        <param name="ariba_reports" format="tabular,txt" type="data" multiple="true" label="Report (tsv) file from ARIBA run" help="This command requires one or more report tsv file generated by ARIBA run command."/>
        <section name="options" title="Optional Arguments">
                <param name="preset" type="select" label="Select a preset">
                    <option value="minimal" selected="True">minimal</option>
                    <option value="cluster_all">cluster all</option>
                    <option value="cluster_var_groups">cluster var groups</option>
                    <option value="all">all</option>
                    <option value="all_no_filter">all no filter</option>
                </param>
                <param name="cluster_cols" type="select" multiple="true" display="checkboxes" label="Cluster columns" help="">
                    <option value="assembled">assembled</option>
                    <option value="match" selected="True">match</option>
                    <option value="ref_seq">ref_seq</option>
                    <option value="pct_id">pct_id</option>
                    <option value="ctg_cov">ctg_cov</option>
                    <option value="known_var">known_var</option>
                    <option value="novel_var">novel_var</option>
                </param>
                <param argument="--col_filter" type="boolean" truevalue="--col_filter" falsevalue="" checked="true" label="Column filter" help="Choose whether columns where all values are No or
                            NA are removed (Default:Yes)" />
                <param argument="--no_tree" type="boolean" truevalue="--no_tree" falsevalue="" checked="false" label="Do not make phandango tree" help="" />
                <param argument="--row_filter" type="boolean" truevalue="--row_filter" falsevalue="" checked="true" label="Row filter" help="Choose whether rows where all values are No or NA
                            are removed (Default: Yes)" />
                <param argument="--min_id" type="integer" value="90" label="Minimum percent identity cutoff to count as assembled" help="(Default: 90)"></param>
                <param argument="--v_groups" type="boolean" truevalue="--v_groups" falsevalue="" checked="false" label="Show a group column for each group of variants" help="" />
                <param argument="--known_variants" type="boolean" truevalue="--known_variants" falsevalue="" checked="false" label="Report all known variants" help="" />
                <param argument="--novel_variants" type="boolean" truevalue="--novel_variants" falsevalue="" checked="false" label="Report all novel variants" help="" />
        </section>
    </inputs>

    <outputs>
        <data name="log" format="tabular"  label="${tool.name} on ${on_string} log file"/>
        <data name="summary_csv" format="tabular"  label="${tool.name} on ${on_string} report file" from_work_dir="out.tsv" />
        <data name="phandango_csv" format="tabular" label="${tool.name} on ${on_string}: Phandango CSV" from_work_dir="out.phandango.csv" />
        <data name="phandango_tree" format="text" label="${tool.name} on ${on_string}: Phandango Tree file" from_work_dir="out.phandango.tre">
            <filter>no_tree is False</filter>
        </data>
    </outputs>

    <help><![CDATA[
            **Usage**: ariba summary out in.report.1.tsv in.report.2.tsv ...

            This tool summarises the results from one or more runs of ARIBA.
           
    ]]>    </help>

    <expand macro="citations" />
</tool>