<tool id="krocus" name="krocus" version="@VERSION@">
    <description>Multi-locus sequence typing (MLST) from uncorrected long reads</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="version_command" />
    <command detect_errors="exit_code"><![CDATA[
        krocus 
        --output_file detected_mlst.tsv
        #if str($opt_args.filtered_reads_file) != ""
            --filtered_reads_file $opt_args.filtered_reads_file
        #end if
        --max_gap $opt_args.max_gap
        --min_kmers_for_onex_pass $opt_args.min_kmers_for_onex_pass
        --margin $opt_args.margin
        --min_block_size $opt_args.min_block_size
        --min_fasta_hits $opt_args.min_fasta_hits
        --min_kmers_for_onex_pass $opt_args.min_kmers_for_onex_pass
        --max_kmers $opt_args.max_kmers
        --print_interval $opt_args.print_interval
        --kmer $opt_args.kmer
        
        #if $opt_args.divisible_by_3
            --divisible_by_3
        #end if
        
        #if $opt_args.verbose
            --verbose
        #end if

        '$krocus_mlst_databases.fields.path' '$fastq'
    ]]></command>
    
    <inputs>
        <param name="fastq" type="data" format="fastqsanger,fastqsanger.gz" label="Select fastq dataset" help="Specify dataset with single read"/>
        <param label="Select a database" name="krocus_mlst_databases" type="select">
            <options from_data_table="krocus_mlst_databases">
                <validator message="No database is available" type="no_options" />
            </options>
        </param>
        <section name="opt_args" title="Optional Arguments">
        <param argument="--filtered_reads_file" type="text" value="" optional="True" label="Filename to save matching reads to" help="Default: None" />
        <param argument="--max_gap" type="integer" value="4" label="Maximum gap for blocks to be contigous, measured in
                        multiples of the k-mer size" help="Default:4" />
        <param argument="--margin" type="integer" value="10" label="Flanking region around a block to use for mapping" help="Default:10" />
        <param argument="--min_block_size" type="integer" value="150" label="Minimum block size in bases" help="Default:150" />
        <param argument="--min_fasta_hits" type="integer" value="10" label="Minimum No. of kmers matching a read" help="Default:10" />
        <param argument="--min_kmers_for_onex_pass" type="integer" value="5" label="Minimum No. of kmers matching a read in 1st pass" help="Default:5" />
        <param argument="--max_kmers" type="integer" value="10" label="Dont count kmers occuring more than this many times" help="Default:10" />
        <param argument="--print_interval" type="integer" value="10" label="Print ST every this number of reads" help="(Default:500)" />
        <param argument="--kmer" type="integer" value="10" label="k-mer size" help="(Default:11)" />
        <param argument="--divisible_by_3" type="boolean" truevalue="--divisible_by_3" falsevalue="" checked="false" label="Genes which are not divisible by 3 are excluded" help="(Default:No)" />
        <param argument="--target_st" type="integer" value="" optional="True" label="For performance testing print time to find given ST" help="(Default:None)" />
        <param argument="--verbose" type="boolean" truevalue="--verbose" falsevalue="" checked="false" label="Turn on debugging" help="(Default:No)" />
        </section>
    </inputs>

    <outputs>
        <data name="output_file" format="tabular" label="${tool.name} on ${on_string}: Output" from_work_dir="detected_mlst.tsv"/>
    </outputs>

    <tests>
        <test>
        <param name="fastq" value="pacbio.fastq.gz" ftype="fastqsanger" />
        <param name="krocus_mlst_databases" value="mlst_db"/>
        <output name="output_file" ftype="tabular" file="mlst_output_pacbio.tsv" compare="contains" />
        </test>
    </tests>

    <help><![CDATA[
    usage: krocus [options] allele_directory input.fastq

    multi-locus sequence typing (MLST) from uncorrected long reads
    
    Documentation can be found at `<https://github.com/andrewjpage/krocus>`_.
    ]]></help>
 <expand macro="citations" />
</tool>
