<tool id="ivar_consensus" name="ivar consensus" version="@VERSION@+galaxy0">
    <description>Call consensus from aligned BAM file</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="version_command" />
    <command detect_errors="exit_code"><![CDATA[
        ln -s '$input_bam' sorted.bam &&
        samtools mpileup -A -d 0 -Q 0 sorted.bam | ivar consensus 
        -p consensus
        -q $min_qual
        -t $min_freq
        -m $min_depth
        $filter_depth
        #if $gap
        -n N
        #end if
    ]]>    </command>
    <inputs>
        <param name="input_bam" type="data" format="bam" label="Bam file" help="Aligned reads, to trim primers and quality"/>
        <param name="min_qual" type="integer" min="0" value="20" label="Minimum quality score threshold to count base"/>
        <param name="min_freq" type="float" min="0" max="1" value="0.0" label="Minimum frequency threshold">
            <help>
                <![CDATA[
           0 - Majority or most common base <br/>
         0.2 - Bases that make up atleast 20% of the depth at a position <br/>
         0.5 - Strict or bases that make up atleast 50% of the depth at a position <br/>
         0.9 - Strict or bases that make up atleast 90% of the depth at a position <br/>
           1 - Identical or bases that make up 100% of the depth at a position. Will have highest ambiguities 
        ]]>
            </help>
        </param>
        <param name="min_depth" type="integer" min="0" value="10" label="Minimum depth to call consensus"/>
        <param name="filter_depth" type="boolean" truevalue="-k" falsevalue="" checked="false" label="Exclude regions with smaller depth than the minimum threshold"/>
        <param name="gap" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Use N instead of - for regions with less than minimum coverage"/>
    </inputs>
    <outputs>
        <data name="consensus" format="fasta" label="${tool.name} on ${on_string} Consensus" from_work_dir="consensus.fa"/>
    </outputs>
    <tests>
        <test>
            <param name="input_bam" value="covid19/PC00101P_sub.trimmed.sorted.bam" />
            <param name="gap" value="true" />
            <output name="consensus" file="covid19/PC00101P_sub.fa" ftype="fasta" compare="contains" lines_diff="1"/>
        </test>
    </tests>
    <help><![CDATA[

    ]]>    </help>
    <expand macro="citations" />
</tool>
